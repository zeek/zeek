# @TEST-EXEC: bash %INPUT

set -euxo pipefail

# The pcaps in $TRACES/smtp/eml-reextraction are named by the hash of the EML file
# they were generated from. Those EML files are in the corresponding baseline file.
# The pcaps have been generated by first extracting EML files from selected, existing, pcaps
# part of the SMTP protocol analyzer test suite. Then, a Python script was used to create a new
# pcap that transmits the contents of the EML file as a single mail SMTP session.
# Those pcaps were generated in two flavours: text (transmission using DATA and .) and
# binary (transmission with BDAT). Before being added as baselines, the resulting EML files
# that did not end with a CRLF had one added to the last line. This was done to ensure that
# the same baseline could be used for binary and text tests.
declare -a hashes=(
	43a21580619bc8b129eb50cad9505a8469685149 # $TRACES/smtp/smtp-bdat-pipeline-8bitmime.pcap
	75e16dfeef57e5bac531f5c48b55adda93822bed # $TRACES/smtp/rfc3030-bdat-example1.pcap
	d66b710b0488fa2b91e8c3177d50f0fec65df25c # $TRACES/smtp-multi-addr.pcap
	d98828e380b8aaff7226f329c1a5acd70a2b76c3 # $TRACES/smtp/rfc3030-bdat-multipart.pcap (+ trailing CRLF)
	ee93d96ae2b5883e8dfe02aca71f799f2b47f1f6 # $TRACES/smtp/smtp-bdat-pipeline-8bitmime.pcap
	f9bc3e476a513159f5c7c5869d47364514605b45 # $TRACES/smtp-attachment-msg.pcap
)

for modality in text binary; do
	for hash in "${hashes[@]}"; do
		trace=$TRACES/smtp/eml-reextraction/$modality/$hash.pcap
		zeek -C -b -r "$trace" - <<- 'EOF'
			@load base/files/extract
			@load base/files/hash
			@load base/protocols/smtp
			@load policy/protocols/mime/mime_mail_as_file

			event file_over_new_connection(f: fa_file, c: connection, is_orig: bool)
			{
				if (SMTP::is_mime_mail(f))
				{
					Files::add_analyzer(f, Files::ANALYZER_SHA1);
					Files::add_analyzer(f, Files::ANALYZER_EXTRACT);
				}
			}
		EOF
		extracted=$(cat files.log | zeek-cut extracted sha1 | grep $hash | awk -- '{print $1}')
		[ -f "extract_files/$extracted" ] && mv "extract_files/$extracted" $hash.eml
		btest-diff --binary $hash.eml
	done
done
